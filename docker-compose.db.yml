services:
    haproxy:
        image: haproxy:latest
        container_name: wot-haproxy
        restart: on-failure
        volumes:
            - type: bind
              source: ./db/haproxy/haproxy.cfg
              target: /usr/local/etc/haproxy/haproxy.cfg
              read_only: true
        ports:
            - 3306:3306
        depends_on:
            - db-galera-1
            - db-galera-2
            - db-galera-3
        networks:
            - wot-galera-network

    db-galera-1:
        image: bitnamilegacy/mariadb-galera:latest
        container_name: wot-galera-1
        hostname: db-galera-1
        restart: on-failure
        environment:
            MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
            MARIADB_DATABASE: ${MARIADB_DATABASE}
            MARIADB_USER: ${MARIADB_USER}
            MARIADB_PASSWORD: ${MARIADB_PASSWORD}
            MARIADB_GALERA_CLUSTER_BOOTSTRAP: ${MARIADB_GALERA_CLUSTER_BOOTSTRAP}
            MARIADB_GALERA_FORCE_SAFETOBOOTSTRAP: ${MARIADB_GALERA_FORCE_SAFETOBOOTSTRAP}
            MARIADB_GALERA_MARIABACKUP_PASSWORD: ${MARIADB_GALERA_MARIABACKUP_PASSWORD}
            MARIADB_GALERA_CLUSTER_NAME: ${MARIADB_GALERA_CLUSTER_NAME}
            MARIADB_GALERA_CLUSTER_ADDRESS: ${MARIADB_GALERA_CLUSTER_ADDRESS}
        volumes:
            - type: volume
              source: mariadb_galera_1_data
              target: /bitnami/mariadb
            - type: bind
              source: ./db/scripts/01-create.sql
              target: /docker-entrypoint-initdb.d/01-create.sql
              read_only: true
            - type: bind
              source: ./db/scripts/02-insert.sql
              target: /docker-entrypoint-initdb.d/02-insert.sql
              read_only: true
        ports:
            - 13306:3306
            - 14567:4567
            - 14568:4568
            - 14444:4444
        networks:
            - wot-galera-network

    db-galera-2:
        image: bitnamilegacy/mariadb-galera:latest
        container_name: wot-galera-2
        hostname: db-galera-2
        restart: on-failure
        environment:
            MARIADB_GALERA_MARIABACKUP_PASSWORD: ${MARIADB_GALERA_MARIABACKUP_PASSWORD}
            MARIADB_GALERA_CLUSTER_NAME: ${MARIADB_GALERA_CLUSTER_NAME}
            MARIADB_GALERA_CLUSTER_ADDRESS: ${MARIADB_GALERA_CLUSTER_ADDRESS}
        volumes:
            - type: volume
              source: mariadb_galera_2_data
              target: /bitnami/mariadb
        ports:
            - 23306:3306
            - 24567:4567
            - 24568:4568
            - 24444:4444
        networks:
            - wot-galera-network

    db-galera-3:
        image: bitnamilegacy/mariadb-galera:latest
        container_name: wot-galera-3
        hostname: db-galera-3
        restart: on-failure
        environment:
            MARIADB_GALERA_MARIABACKUP_PASSWORD: ${MARIADB_GALERA_MARIABACKUP_PASSWORD}
            MARIADB_GALERA_CLUSTER_NAME: ${MARIADB_GALERA_CLUSTER_NAME}
            MARIADB_GALERA_CLUSTER_ADDRESS: ${MARIADB_GALERA_CLUSTER_ADDRESS}
        volumes:
            - type: volume
              source: mariadb_galera_3_data
              target: /bitnami/mariadb
        ports:
            - 33306:3306
            - 34567:4567
            - 34568:4568
            - 34444:4444
        networks:
            - wot-galera-network

volumes:
    mariadb_galera_1_data:
        driver: local
    mariadb_galera_2_data:
        driver: local
    mariadb_galera_3_data:
        driver: local

networks:
    wot-galera-network:
        name: wot-galera-network
        driver: bridge
