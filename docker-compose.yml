services:
    nginx:
        image: nginx:alpine
        container_name: wot-nginx
        restart: on-failure
        ports:
            - "80:80"
        volumes:
            - type: bind
              source: ./nginx/nginx.conf
              target: /etc/nginx/nginx.conf
              read_only: true
        depends_on:
            api-1:
                condition: service_healthy
            api-2:
                condition: service_healthy
            web-1:
                condition: service_healthy
            web-2:
                condition: service_healthy
            minio:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
            interval: 10s
            timeout: 3s
            retries: 3
            start_period: 5s
        networks:
            - wot-network

    minio:
        image: minio/minio:latest
        container_name: wot-minio
        restart: on-failure
        command: server /data --console-address ":9001"
        environment:
            MINIO_ROOT_USER: ${MINIO_ROOT_USER}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
            MINIO_BROWSER_REDIRECT_URL: http://localhost:8080/minio/
        ports:
            - "9000:9000" 
            - "9001:9001"
        volumes:
            - type: volume
              source: minio_data
              target: /data
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
            interval: 10s
            timeout: 3s
            retries: 3
            start_period: 10s
        networks:
            - wot-network

    api-1:
        build:
            context: ./apps/api
            dockerfile: Dockerfile
        container_name: wot-api-1
        restart: on-failure
        environment:
            SERVICE_NAME: "api-1"
            DATABASE_PORT: ${HAPROXY_PORT}
            DATABASE_HOST: "haproxy"
            DATABASE_NAME: ${MARIADB_DATABASE}
            DATABASE_USER: ${MARIADB_USER}
            DATABASE_PASSWORD: ${MARIADB_PASSWORD}
            JWT_SECRET: ${JWT_SECRET}
            JWT_EXPIRATION: ${JWT_EXPIRATION}
            NODE_ENV: "production"
            PORT: 3101
        volumes:
            - type: bind
              source: ./apps/api
              target: /app
            - type: volume
              source: api_1_node_modules
              target: /app/node_modules
        depends_on:
            haproxy:
                condition: service_healthy
            minio:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3101/health"]
            interval: 10s
            timeout: 3s
            retries: 3
            start_period: 10s
        networks:
            - wot-network

    api-2:
        build:
            context: ./apps/api
            dockerfile: Dockerfile
        container_name: wot-api-2
        restart: on-failure
        environment:
            SERVICE_NAME: "api-2"
            DATABASE_PORT: ${HAPROXY_PORT}
            DATABASE_HOST: "haproxy"
            DATABASE_NAME: ${MARIADB_DATABASE}
            DATABASE_USER: ${MARIADB_USER}
            DATABASE_PASSWORD: ${MARIADB_PASSWORD}
            JWT_SECRET: ${JWT_SECRET}
            JWT_EXPIRATION: ${JWT_EXPIRATION}
            NODE_ENV: "production"
            PORT: 3102
        volumes:
            - type: bind
              source: ./apps/api
              target: /app
            - type: volume
              source: api_2_node_modules
              target: /app/node_modules
        depends_on:
            haproxy:
                condition: service_healthy
            minio:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3102/health"]
            interval: 10s
            timeout: 3s
            retries: 3
            start_period: 10s
        networks:
            - wot-network
    
    web-1:
        build:
            context: ./apps/web
            dockerfile: Dockerfile
        container_name: wot-web-1
        restart: on-failure
        environment:
            PORT: 3001
        ports:
            - "3001:3001"
        volumes:
            - type: bind
              source: ./apps/web
              target: /app
            - type: volume
              source: web_1_node_modules
              target: /app/node_modules
            - type: volume
              source: web_1_next      
              target: /app/.next
        depends_on:
            api-1:
                condition: service_healthy
            api-2:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
            interval: 10s
            timeout: 3s
            retries: 3
            start_period: 10s
        networks:
            - wot-network

    web-2:
        build:
            context: ./apps/web
            dockerfile: Dockerfile
        container_name: wot-web-2
        restart: on-failure
        environment:
            PORT: 3002
        ports:
            - "3002:3002"
        volumes:
            - type: bind
              source: ./apps/web
              target: /app
            - type: volume
              source: web_2_node_modules
              target: /app/node_modules
            - type: volume
              source: web_2_next
              target: /app/.next
        depends_on:
            api-1:
                condition: service_healthy
            api-2:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
            interval: 10s
            timeout: 3s
            retries: 3
            start_period: 10s
        networks:
            - wot-network

volumes:
    api_1_node_modules:
        driver: local
    api_2_node_modules:
        driver: local
    web_1_node_modules:
        driver: local
    web_2_node_modules:
        driver: local
    web_1_next:
        driver: local
    web_2_next:
        driver: local
    minio_data:
        driver: local

networks:
    wot-network:
        name: wot-network
        driver: bridge
