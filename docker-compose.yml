services:
    nginx:
        image: nginx:alpine
        container_name: wot-nginx
        restart: on-failure
        ports:
            - "80:80"
        volumes:
            - type: bind
              source: ./nginx/nginx.conf
              target: /etc/nginx/nginx.conf
              read_only: true
        depends_on:
            api-1:
                condition: service_healthy
            api-2:
                condition: service_healthy
            web-1:
                condition: service_healthy
            web-2:
                condition: service_healthy
            ai:
                condition: service_healthy
            minio:
                condition: service_healthy
            mailhog:
                condition: service_started
        healthcheck:
            test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
            interval: 10s
            timeout: 3s
            retries: 3
            start_period: 5s
        networks:
            - wot-network

    minio:
        image: minio/minio:latest
        container_name: wot-minio
        restart: on-failure
        command: server /data --console-address ":9001"
        environment:
            MINIO_ROOT_USER: ${MINIO_ROOT_USER}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
            MINIO_BROWSER_REDIRECT_URL: http://localhost:8080/minio/
        ports:
            - "9000:9000" 
            - "9001:9001"
        volumes:
            - type: volume
              source: minio_data
              target: /data
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
            interval: 10s
            timeout: 3s
            retries: 3
            start_period: 10s
        networks:
            - wot-network

    minio-init:
        image: minio/mc:latest
        container_name: wot-minio-init
        depends_on:
            minio:
                condition: service_healthy
        environment:
            MINIO_ROOT_USER: ${MINIO_ROOT_USER}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
        volumes:
            - type: bind
              source: ./minio/init-data/init-minio.sh
              target: /init-minio.sh
              read_only: true
            - type: bind
              source: ./minio/init-data/sample-images
              target: /sample-images
              read_only: true
        entrypoint: ["/bin/sh", "/init-minio.sh"]
        networks:
            - wot-network

    mailhog:
        image: mailhog/mailhog:latest
        container_name: wot-mailhog
        restart: on-failure
        ports:
            - "8025:8025"
            - "1025:1025"
        networks:
            - wot-network

    api-1:
        build:
            context: ./apps/api
            dockerfile: Dockerfile
        container_name: wot-api-1
        restart: on-failure
        environment:
            SERVICE_NAME: "api-1"
            DATABASE_PORT: 3306
            DATABASE_HOST: "haproxy"
            DATABASE_NAME: ${MARIADB_DATABASE}
            DATABASE_USER: ${MARIADB_USER}
            DATABASE_PASSWORD: ${MARIADB_PASSWORD}
            JWT_SECRET: ${JWT_SECRET}
            JWT_EXPIRATION: ${JWT_EXPIRATION}
            JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION}
            EMAIL_VERIFICATION_TOKEN_EXPIRATION: ${EMAIL_VERIFICATION_TOKEN_EXPIRATION}
            PASSWORD_RESET_TOKEN_EXPIRATION: ${PASSWORD_RESET_TOKEN_EXPIRATION}
            COMMENT_SOFT_DELETE_RETENTION: ${COMMENT_SOFT_DELETE_RETENTION}
            FRONTEND_URL: ${FRONTEND_URL}
            MAIL_HOST: "mailhog"
            MAIL_PORT: 1025
            MAIL_FROM: ${MAIL_FROM}
            NODE_ENV: "production"
            PORT: 3101
        volumes:
            - type: bind
              source: ./apps/api
              target: /app
            - type: volume
              source: api_1_node_modules
              target: /app/node_modules
        depends_on:
            haproxy:
                condition: service_healthy
            minio:
                condition: service_healthy
            mailhog:
                condition: service_started
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3101/health"]
            interval: 10s
            timeout: 3s
            retries: 3
            start_period: 10s
        networks:
            - wot-network

    api-2:
        build:
            context: ./apps/api
            dockerfile: Dockerfile
        container_name: wot-api-2
        restart: on-failure
        environment:
            SERVICE_NAME: "api-2"
            DATABASE_PORT: 3306
            DATABASE_HOST: "haproxy"
            DATABASE_NAME: ${MARIADB_DATABASE}
            DATABASE_USER: ${MARIADB_USER}
            DATABASE_PASSWORD: ${MARIADB_PASSWORD}
            JWT_SECRET: ${JWT_SECRET}
            JWT_EXPIRATION: ${JWT_EXPIRATION}
            JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION}
            EMAIL_VERIFICATION_TOKEN_EXPIRATION: ${EMAIL_VERIFICATION_TOKEN_EXPIRATION}
            PASSWORD_RESET_TOKEN_EXPIRATION: ${PASSWORD_RESET_TOKEN_EXPIRATION}
            COMMENT_SOFT_DELETE_RETENTION: ${COMMENT_SOFT_DELETE_RETENTION}
            FRONTEND_URL: ${FRONTEND_URL}
            MAIL_HOST: "mailhog"
            MAIL_PORT: 1025
            MAIL_FROM: ${MAIL_FROM}
            NODE_ENV: "production"
            PORT: 3102
        volumes:
            - type: bind
              source: ./apps/api
              target: /app
            - type: volume
              source: api_2_node_modules
              target: /app/node_modules
        depends_on:
            haproxy:
                condition: service_healthy
            minio:
                condition: service_healthy
            mailhog:
                condition: service_started
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3102/health"]
            interval: 10s
            timeout: 3s
            retries: 3
            start_period: 10s
        networks:
            - wot-network
    
    ai:
        build:
            context: ./apps/ai
            dockerfile: Dockerfile
        container_name: wot-ai
        restart: on-failure
        environment:
            HOST: 0.0.0.0
            PORT: 5000
            DEBUG: "False"
            WORKERS: ${AI_WORKERS}
            SERVICE_AREA: ${AI_SERVICE_AREA}
            NETWORK_TYPE: ${AI_NETWORK_TYPE}
            WALKING_SPEED_MPS: ${AI_WALKING_SPEED_MPS}
            GRAPH_CACHE_DIR: /app/cache
            SIMPLIFY_GRAPH: ${AI_SIMPLIFY_GRAPH}
            LOG_LEVEL: ${AI_LOG_LEVEL}
            REQUEST_TIMEOUT: ${AI_REQUEST_TIMEOUT}
            GRAPH_LOAD_TIMEOUT: ${AI_GRAPH_LOAD_TIMEOUT}
        ports:
            - "5000:5000"
        volumes:
            - type: volume
              source: ai_cache
              target: /app/cache
            - type: volume
              source: ai_data
              target: /app/data
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s
        networks:
            - wot-network
    
    web-1:
        build:
            context: ./apps/web
            dockerfile: Dockerfile
        container_name: wot-web-1
        restart: on-failure
        environment:
            PORT: 3001
        ports:
            - "3001:3001"
        volumes:
            - type: bind
              source: ./apps/web
              target: /app
            - type: volume
              source: web_1_node_modules
              target: /app/node_modules
            - type: volume
              source: web_1_next      
              target: /app/.next
        depends_on:
            api-1:
                condition: service_healthy
            api-2:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
            interval: 10s
            timeout: 3s
            retries: 3
            start_period: 10s
        networks:
            - wot-network

    web-2:
        build:
            context: ./apps/web
            dockerfile: Dockerfile
        container_name: wot-web-2
        restart: on-failure
        environment:
            PORT: 3002
        ports:
            - "3002:3002"
        volumes:
            - type: bind
              source: ./apps/web
              target: /app
            - type: volume
              source: web_2_node_modules
              target: /app/node_modules
            - type: volume
              source: web_2_next
              target: /app/.next
        depends_on:
            api-1:
                condition: service_healthy
            api-2:
                condition: service_healthy
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
            interval: 10s
            timeout: 3s
            retries: 3
            start_period: 10s
        networks:
            - wot-network

volumes:
    api_1_node_modules:
        driver: local
    api_2_node_modules:
        driver: local
    web_1_node_modules:
        driver: local
    web_2_node_modules:
        driver: local
    web_1_next:
        driver: local
    web_2_next:
        driver: local
    minio_data:
        driver: local
    ai_cache:
        driver: local
    ai_data:
        driver: local

networks:
    wot-network:
        name: wot-network
        driver: bridge
