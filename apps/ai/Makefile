.PHONY: help build build-dev up up-dev down logs test clean install lock update format lint

help:
	@echo "Route Calculator Service - Makefile"
	@echo ""
	@echo "üì¶ Gerenciamento de Depend√™ncias:"
	@echo "  make install    - Instala depend√™ncias com Poetry"
	@echo "  make lock       - Gera/atualiza poetry.lock"
	@echo "  make update     - Atualiza depend√™ncias"
	@echo "  make add PKG=x  - Adiciona nova depend√™ncia"
	@echo ""
	@echo "üê≥ Docker:"
	@echo "  make build      - Constr√≥i imagem de produ√ß√£o"
	@echo "  make build-dev  - Constr√≥i imagem de desenvolvimento"
	@echo "  make up         - Inicia servi√ßo (produ√ß√£o)"
	@echo "  make up-dev     - Inicia servi√ßo (desenvolvimento)"
	@echo "  make down       - Para servi√ßo"
	@echo "  make logs       - Visualiza logs"
	@echo ""
	@echo "üß™ Testes e Qualidade:"
	@echo "  make test       - Executa testes"
	@echo "  make format     - Formata c√≥digo com Black"
	@echo "  make lint       - Verifica c√≥digo com Flake8"
	@echo "  make health     - Verifica sa√∫de do servi√ßo"
	@echo "  make test-route - Testa c√°lculo de rota"
	@echo ""
	@echo "üßπ Limpeza:"
	@echo "  make clean      - Remove volumes e cache"
	@echo ""

# Dependency management
install:
	poetry install

lock:
	poetry lock

update:
	poetry update

add:
	poetry add $(PKG)

# Docker
build:
	cd ../.. && docker-compose build ai

build-dev:
	cd ../.. && docker-compose -f docker-compose.dev.yml build ai

up:
	cd ../.. && docker-compose up -d ai

up-dev:
	cd ../.. && docker-compose -f docker-compose.dev.yml up ai

down:
	cd ../.. && docker-compose stop ai

logs:
	cd ../.. && docker-compose logs -f ai

# Testing and quality
test:
	poetry run pytest

format:
	poetry run black src/

lint:
	poetry run flake8 src/

health:
	@curl -s http://localhost:5000/health | python3 -m json.tool

test-route:
	@echo "Testando rota em Lisboa..."
	@curl -s "http://localhost:5000/38.7072,-9.1365/38.7139,-9.1334/" | python3 -m json.tool

# Local development
run-local:
	poetry run python -m src.app

shell:
	poetry shell

# Cleanup
clean:
	cd ../.. && docker-compose down -v ai
	rm -rf .pytest_cache .coverage htmlcov/
	find . -type d -name __pycache__ -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
